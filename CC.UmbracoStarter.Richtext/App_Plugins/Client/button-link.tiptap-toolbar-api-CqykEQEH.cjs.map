{"version":3,"file":"button-link.tiptap-toolbar-api-CqykEQEH.cjs","sources":["../../Client/src/button-link/button-link-modal/button-link-modal.token.ts","../../Client/src/button-link/button-link-tiptap/button-link.tiptap-toolbar-api.ts"],"sourcesContent":["import { BUTTON_LINK_MODAL_ALIAS } from \"./constants.js\";\r\nimport type { ButtonLinkPickerLink } from \"./types.js\";\r\nimport { UmbModalToken } from \"@umbraco-cms/backoffice/modal\";\r\n\r\nexport interface ButtonLinkPickerModalData {\r\n  config: UmbLinkPickerConfig;\r\n  index: number | null;\r\n  isNew: boolean;\r\n}\r\n\r\nexport type ButtonLinkPickerModalValue = { link: ButtonLinkPickerLink };\r\n\r\nexport interface UmbLinkPickerConfig {\r\n  hideAnchor?: boolean;\r\n  hideTarget?: boolean;\r\n}\r\n\r\nexport const BUTTON_LINK_MODAL = new UmbModalToken<\r\n  ButtonLinkPickerModalData,\r\n  ButtonLinkPickerModalValue\r\n>(BUTTON_LINK_MODAL_ALIAS, {\r\n  modal: {\r\n    type: \"sidebar\",\r\n    size: \"medium\",\r\n  },\r\n});\r\n","import { UmbLink } from \"@umbraco-cms/backoffice/external/tiptap\";\r\nimport { UMB_MODAL_MANAGER_CONTEXT } from \"@umbraco-cms/backoffice/modal\";\r\nimport type { Editor } from \"@umbraco-cms/backoffice/external/tiptap\";\r\nimport type { UUIModalSidebarSize } from \"@umbraco-cms/backoffice/external/uui\";\r\nimport { UmbTiptapToolbarElementApiBase } from \"@umbraco-cms/backoffice/tiptap\";\r\nimport { ButtonLinkAttributes } from \"./button-link\";\r\nimport { BUTTON_LINK_MODAL, ButtonLinkPickerLink } from \"../button-link-modal\";\r\n\r\nexport default class ButtonTiptalToolbarExtensionApi extends UmbTiptapToolbarElementApiBase {\r\n  override async execute(editor?: Editor) {\r\n    const attrs = editor?.getAttributes(UmbLink.name) ?? {};\r\n    let link = this.#getLinkData(attrs);\r\n    const data = { config: {}, index: null, isNew: link?.url === undefined };\r\n    const value = { link };\r\n\r\n    const overlaySize =\r\n      this.configuration?.getValueByAlias<UUIModalSidebarSize>(\"overlaySize\") ??\r\n      \"small\";\r\n\r\n    const modalManager = await this.getContext(UMB_MODAL_MANAGER_CONTEXT);\r\n    const modalHandler = modalManager.open(this, BUTTON_LINK_MODAL, {\r\n      data,\r\n      value,\r\n      modal: { size: overlaySize },\r\n    });\r\n\r\n    if (!modalHandler) return;\r\n\r\n    const result = await modalHandler.onSubmit().catch(() => undefined);\r\n    if (!result?.link) return;\r\n    link = result.link;\r\n\r\n    const linkAttrs = this.#parseLinkData(link);\r\n\r\n    if (linkAttrs) {\r\n      editor\r\n        ?.chain()\r\n        .focus()\r\n        .extendMarkRange(UmbLink.name)\r\n        .setButtonLink(linkAttrs)\r\n        .run();\r\n    } else {\r\n      editor\r\n        ?.chain()\r\n        .focus()\r\n        .extendMarkRange(UmbLink.name)\r\n        .unsetButtonLink()\r\n        .run();\r\n    }\r\n  }\r\n\r\n  #getLinkData(attrs: Record<string, any>): ButtonLinkPickerLink {\r\n    const queryString = attrs[\"data-anchor\"];\r\n    const url = attrs.href?.substring(\r\n      0,\r\n      attrs.href.length - (queryString?.length ?? 0)\r\n    );\r\n    const unique = url?.includes(\"localLink:\")\r\n      ? url.substring(url.indexOf(\":\") + 1, url.indexOf(\"}\"))\r\n      : null;\r\n\r\n    return {\r\n      name: attrs.title,\r\n      queryString,\r\n      target: attrs.target,\r\n      type: attrs.type,\r\n      unique,\r\n      url,\r\n    };\r\n  }\r\n\r\n  #parseLinkData(link: ButtonLinkPickerLink): ButtonLinkAttributes | null {\r\n    const { name, target, type, unique, backgroundColor } = link;\r\n    let { queryString, url } = link;\r\n\r\n    // If an anchor exists, check that it is appropriately prefixed\r\n    queryString = this.#queryStringFromUrl(queryString);\r\n\r\n    // The href might be an external url, so check the value for an anchor/querystring;\r\n    // `href` has the anchor re-appended later, hence the reset here to avoid duplicating the anchor\r\n    if (!queryString) {\r\n      const extractedInfo = this.#extractUrlAndQueryString(url, queryString);\r\n      url = extractedInfo.url;\r\n      queryString = extractedInfo.queryString;\r\n    }\r\n\r\n    // If we have a unique id, it must be a `/{localLink:guid}`\r\n    if (unique) {\r\n      url = `/{localLink:${unique}}`;\r\n    } else {\r\n      // If it's an email address and not `//user@domain.com` and protocol (e.g. mailto:, sip:) is not specified;\r\n      // then we'll assume it should be a \"mailto\" link.\r\n      url = this.#transformURLToMailto(url);\r\n\r\n      url = this.#ensureHttpProtocol(url);\r\n    }\r\n\r\n    const anchor = this.#getAnchorFromQueryString(queryString);\r\n\r\n    if (anchor) {\r\n      url = (url ?? \"\") + anchor;\r\n    }\r\n\r\n    if (!url) return null;\r\n    const styles: { [key: string]: string } = {};\r\n\r\n    if (backgroundColor) {\r\n      styles[\"--color-background\"] = backgroundColor;\r\n    }\r\n\r\n    return {\r\n      type: type ?? \"external\",\r\n      href: url,\r\n      class: \"btn\",\r\n      style: styles,\r\n      \"data-anchor\": anchor,\r\n      target,\r\n      title: name ?? url,\r\n    };\r\n  }\r\n\r\n  #extractUrlAndQueryString(\r\n    url: string | null | undefined,\r\n    queryString: string | null\r\n  ) {\r\n    const urlParts = url?.split(/([#?])/);\r\n    if (urlParts?.length === 3) {\r\n      url = urlParts[0];\r\n      queryString = urlParts[1] + urlParts[2];\r\n    }\r\n    return { url, queryString };\r\n  }\r\n\r\n  /**\r\n   * If the URL is prefixed \"www.\", then prepend \"http://\" protocol scheme.\r\n   * @param url\r\n   */\r\n  #ensureHttpProtocol(url: string | null | undefined) {\r\n    if (!url) return null;\r\n    if (/^\\s*www\\./i.test(url)) {\r\n      url = `http://${url}`;\r\n    }\r\n    return url;\r\n  }\r\n\r\n  /**\r\n   * If the URL is an email address, then prepend \"mailto:\" protocol scheme.\r\n   * @param url\r\n   */\r\n  #transformURLToMailto(url: string | null | undefined) {\r\n    if (!url) return null;\r\n    if (url?.includes(\"@\") && !url.includes(\"//\") && !url.includes(\":\")) {\r\n      url = `mailto:${url}`;\r\n    }\r\n    return url;\r\n  }\r\n\r\n  /**\r\n   * If the URL contains an anchor, then return the anchor.\r\n   * @param queryString\r\n   */\r\n  #getAnchorFromQueryString(queryString: string | null) {\r\n    if (!queryString) return null;\r\n    return queryString.startsWith(\"#\") || queryString.startsWith(\"?\")\r\n      ? queryString\r\n      : null;\r\n  }\r\n\r\n  /**\r\n   * If the query string does not start with \"?\" or \"#\", then prepend it.\r\n   * @param queryString\r\n   */\r\n  #queryStringFromUrl(queryString: string | null | undefined) {\r\n    if (!queryString) return null;\r\n    if (!queryString.startsWith(\"?\") && !queryString.startsWith(\"#\")) {\r\n      queryString = (queryString.startsWith(\"=\") ? \"#\" : \"?\") + queryString;\r\n    }\r\n    return queryString;\r\n  }\r\n}\r\n"],"names":["BUTTON_LINK_MODAL","UmbModalToken","BUTTON_LINK_MODAL_ALIAS","ButtonTiptalToolbarExtensionApi","UmbTiptapToolbarElementApiBase","__privateAdd","_ButtonTiptalToolbarExtensionApi_instances","editor","attrs","UmbLink","link","__privateMethod","getLinkData_fn","data","value","overlaySize","_a","modalHandler","UMB_MODAL_MANAGER_CONTEXT","result","linkAttrs","parseLinkData_fn","queryString","url","unique","name","target","type","backgroundColor","queryStringFromUrl_fn","extractedInfo","extractUrlAndQueryString_fn","transformURLToMailto_fn","ensureHttpProtocol_fn","anchor","getAnchorFromQueryString_fn","styles","urlParts"],"mappings":"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"}