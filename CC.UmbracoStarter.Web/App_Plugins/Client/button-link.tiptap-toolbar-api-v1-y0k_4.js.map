{"version":3,"file":"button-link.tiptap-toolbar-api-v1-y0k_4.js","sources":["../../Client/src/button-link/button-link-modal/button-link-modal.token.ts","../../Client/src/button-link/button-link-tiptap/button-link.tiptap-toolbar-api.ts"],"sourcesContent":["import { BUTTON_LINK_MODAL_ALIAS } from \"./constants.js\";\r\nimport type { ButtonLinkPickerLink } from \"./types.js\";\r\nimport { UmbModalToken } from \"@umbraco-cms/backoffice/modal\";\r\n\r\nexport interface ButtonLinkPickerModalData {\r\n  config: UmbLinkPickerConfig;\r\n  index: number | null;\r\n  isNew: boolean;\r\n}\r\n\r\nexport type ButtonLinkPickerModalValue = { link: ButtonLinkPickerLink };\r\n\r\nexport interface UmbLinkPickerConfig {\r\n  hideAnchor?: boolean;\r\n  hideTarget?: boolean;\r\n}\r\n\r\nexport const BUTTON_LINK_MODAL = new UmbModalToken<\r\n  ButtonLinkPickerModalData,\r\n  ButtonLinkPickerModalValue\r\n>(BUTTON_LINK_MODAL_ALIAS, {\r\n  modal: {\r\n    type: \"sidebar\",\r\n    size: \"medium\",\r\n  },\r\n});\r\n","import { UmbLink } from \"@umbraco-cms/backoffice/external/tiptap\";\r\nimport { UMB_MODAL_MANAGER_CONTEXT } from \"@umbraco-cms/backoffice/modal\";\r\nimport type { Editor } from \"@umbraco-cms/backoffice/external/tiptap\";\r\nimport type { UUIModalSidebarSize } from \"@umbraco-cms/backoffice/external/uui\";\r\nimport { UmbTiptapToolbarElementApiBase } from \"@umbraco-cms/backoffice/tiptap\";\r\nimport { ButtonLinkAttributes } from \"./button-link\";\r\nimport { BUTTON_LINK_MODAL, ButtonLinkPickerLink } from \"../button-link-modal\";\r\n\r\nexport default class ButtonTiptalToolbarExtensionApi extends UmbTiptapToolbarElementApiBase {\r\n  override async execute(editor?: Editor) {\r\n    const attrs = editor?.getAttributes(UmbLink.name) ?? {};\r\n    let link = this.#getLinkData(attrs);\r\n    const data = { config: {}, index: null, isNew: link?.url === undefined };\r\n    const value = { link };\r\n\r\n    const overlaySize =\r\n      this.configuration?.getValueByAlias<UUIModalSidebarSize>(\"overlaySize\") ??\r\n      \"small\";\r\n\r\n    const modalManager = await this.getContext(UMB_MODAL_MANAGER_CONTEXT);\r\n    const modalHandler = modalManager.open(this, BUTTON_LINK_MODAL, {\r\n      data,\r\n      value,\r\n      modal: { size: overlaySize },\r\n    });\r\n\r\n    if (!modalHandler) return;\r\n\r\n    const result = await modalHandler.onSubmit().catch(() => undefined);\r\n    if (!result?.link) return;\r\n    link = result.link;\r\n\r\n    const linkAttrs = this.#parseLinkData(link);\r\n\r\n    if (linkAttrs) {\r\n      editor\r\n        ?.chain()\r\n        .focus()\r\n        .extendMarkRange(UmbLink.name)\r\n        .setButtonLink(linkAttrs)\r\n        .run();\r\n    } else {\r\n      editor\r\n        ?.chain()\r\n        .focus()\r\n        .extendMarkRange(UmbLink.name)\r\n        .unsetButtonLink()\r\n        .run();\r\n    }\r\n  }\r\n\r\n  #getLinkData(attrs: Record<string, any>): ButtonLinkPickerLink {\r\n    const queryString = attrs[\"data-anchor\"];\r\n    const url = attrs.href?.substring(\r\n      0,\r\n      attrs.href.length - (queryString?.length ?? 0)\r\n    );\r\n    const unique = url?.includes(\"localLink:\")\r\n      ? url.substring(url.indexOf(\":\") + 1, url.indexOf(\"}\"))\r\n      : null;\r\n\r\n    return {\r\n      name: attrs.title,\r\n      queryString,\r\n      target: attrs.target,\r\n      type: attrs.type,\r\n      unique,\r\n      url,\r\n    };\r\n  }\r\n\r\n  #parseLinkData(link: ButtonLinkPickerLink): ButtonLinkAttributes | null {\r\n    const { name, target, type, unique, backgroundColor } = link;\r\n    let { queryString, url } = link;\r\n\r\n    // If an anchor exists, check that it is appropriately prefixed\r\n    queryString = this.#queryStringFromUrl(queryString);\r\n\r\n    // The href might be an external url, so check the value for an anchor/querystring;\r\n    // `href` has the anchor re-appended later, hence the reset here to avoid duplicating the anchor\r\n    if (!queryString) {\r\n      const extractedInfo = this.#extractUrlAndQueryString(url, queryString);\r\n      url = extractedInfo.url;\r\n      queryString = extractedInfo.queryString;\r\n    }\r\n\r\n    // If we have a unique id, it must be a `/{localLink:guid}`\r\n    if (unique) {\r\n      url = `/{localLink:${unique}}`;\r\n    } else {\r\n      // If it's an email address and not `//user@domain.com` and protocol (e.g. mailto:, sip:) is not specified;\r\n      // then we'll assume it should be a \"mailto\" link.\r\n      url = this.#transformURLToMailto(url);\r\n\r\n      url = this.#ensureHttpProtocol(url);\r\n    }\r\n\r\n    const anchor = this.#getAnchorFromQueryString(queryString);\r\n\r\n    if (anchor) {\r\n      url = (url ?? \"\") + anchor;\r\n    }\r\n\r\n    if (!url) return null;\r\n    const styles: { [key: string]: string } = {};\r\n\r\n    if (backgroundColor) {\r\n      styles[\"--color-background\"] = backgroundColor;\r\n    }\r\n\r\n    return {\r\n      type: type ?? \"external\",\r\n      href: url,\r\n      class: \"btn\",\r\n      style: styles,\r\n      \"data-anchor\": anchor,\r\n      target,\r\n      title: name ?? url,\r\n    };\r\n  }\r\n\r\n  #extractUrlAndQueryString(\r\n    url: string | null | undefined,\r\n    queryString: string | null\r\n  ) {\r\n    const urlParts = url?.split(/([#?])/);\r\n    if (urlParts?.length === 3) {\r\n      url = urlParts[0];\r\n      queryString = urlParts[1] + urlParts[2];\r\n    }\r\n    return { url, queryString };\r\n  }\r\n\r\n  /**\r\n   * If the URL is prefixed \"www.\", then prepend \"http://\" protocol scheme.\r\n   * @param url\r\n   */\r\n  #ensureHttpProtocol(url: string | null | undefined) {\r\n    if (!url) return null;\r\n    if (/^\\s*www\\./i.test(url)) {\r\n      url = `http://${url}`;\r\n    }\r\n    return url;\r\n  }\r\n\r\n  /**\r\n   * If the URL is an email address, then prepend \"mailto:\" protocol scheme.\r\n   * @param url\r\n   */\r\n  #transformURLToMailto(url: string | null | undefined) {\r\n    if (!url) return null;\r\n    if (url?.includes(\"@\") && !url.includes(\"//\") && !url.includes(\":\")) {\r\n      url = `mailto:${url}`;\r\n    }\r\n    return url;\r\n  }\r\n\r\n  /**\r\n   * If the URL contains an anchor, then return the anchor.\r\n   * @param queryString\r\n   */\r\n  #getAnchorFromQueryString(queryString: string | null) {\r\n    if (!queryString) return null;\r\n    return queryString.startsWith(\"#\") || queryString.startsWith(\"?\")\r\n      ? queryString\r\n      : null;\r\n  }\r\n\r\n  /**\r\n   * If the query string does not start with \"?\" or \"#\", then prepend it.\r\n   * @param queryString\r\n   */\r\n  #queryStringFromUrl(queryString: string | null | undefined) {\r\n    if (!queryString) return null;\r\n    if (!queryString.startsWith(\"?\") && !queryString.startsWith(\"#\")) {\r\n      queryString = (queryString.startsWith(\"=\") ? \"#\" : \"?\") + queryString;\r\n    }\r\n    return queryString;\r\n  }\r\n}\r\n"],"names":["BUTTON_LINK_MODAL","UmbModalToken","BUTTON_LINK_MODAL_ALIAS","ButtonTiptalToolbarExtensionApi","UmbTiptapToolbarElementApiBase","__privateAdd","_ButtonTiptalToolbarExtensionApi_instances","editor","attrs","UmbLink","link","__privateMethod","getLinkData_fn","data","value","overlaySize","_a","modalHandler","UMB_MODAL_MANAGER_CONTEXT","result","linkAttrs","parseLinkData_fn","queryString","url","unique","name","target","type","backgroundColor","queryStringFromUrl_fn","extractedInfo","extractUrlAndQueryString_fn","transformURLToMailto_fn","ensureHttpProtocol_fn","anchor","getAnchorFromQueryString_fn","styles","urlParts"],"mappings":"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"}